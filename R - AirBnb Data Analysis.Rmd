---
title: "Airbnb Data Analysis and Predictive Modeling"
author: "Marius Goffart, Lennart Rathje, Hanna Casperson, Emily Cain, and Connie Kang"
date: "December 11, 2018"
output:
  pdf_document:
    toc: yes
    always_allow_html: yes
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

<style>
h1.title{
text-align:left
}
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##1.0 Background and Objective

Our team has been hypothetically hired by Airbnb in order to provide them with meaningful, actionable insights from a plethora of data on tens of thousands of Airbnb listings. This information will then be used to provide analysis to renters on Airbnb in regard to which types of properties rent the best (giving them insights into how to best market their rental properties or aquire new ones). Based on the results of our analysis, Airbnb listings could better help management and hosts to understand pricing, market trends, and consumers' value drivers to maximize their profit.

The initial dataset we received contains over 74 thousand observations and describes Airbnb listings from six major cities: Boston, Los Angeles, Chicago, New York City, San Fransisco, and Washington D.C.

We were given information split into 29 variables including, but not limited to, the following: location information (city, coordinates, zip code), Airbnb "room" offering information (the natural log of the nightly price, description, amenities, maximum number of people accommodated, number of bedrooms and bathrooms, and property, room, and bed classification types), and host information (response rate, presence of profile pic and identity verification, length of time on Airbnb).

##2.0 Preparing to explore the data

###2.1 Importing the data & libraries


```{r library, message=FALSE}
library(dplyr)
library(ggpubr)
library(stats)
library(stringr)
library(ggplot2)
library(kableExtra)
library(lmtest)
library(leaflet)
library(neuralnet)
library(C50)
library(gridExtra)
library(geosphere)
```

We first import the data we were provided by our client.

```{r read data, message = FALSE}
a <- read.csv("train.csv")
income <- read.csv("LA_income.csv")
```

Instead of confusing and compromising the results of our eventual predictive modeling by trying to look at all the cities, we want to increase our accuracy by narrowing our scope.

We choose to look specifically at Los Angeles, because LA is a significantly sized segment (about 30% of total provided Airbnb data), and we also expect the listings in LA to be more heterogeneous, which bodes well for the quality of our predictive modeling.

```{r LA subset, message = FALSE}
#Extracting subset including all LA data
la <- subset(a, city == "LA")
la$zipcode <- as.character(la$zipcode)
la$zipcode <- as.integer(la$zipcode)
```

We have now extracted our very rough preliminary dataset for Airbnb listings in Los Angeles, California.

###2.2 Cleaning the data

First, we edit the given data to faciliate usage. This importantly starts with basic conversion of several variables into their correct, most usable class/format.

For some variables that have an excessive number of options/levels, we cluster them into a smaller amount of levels to be able to use them easier. Graphs below will support those clustering measures.

We also remove many missing values (NAs) and fill them in with information in order to facilitate later analysis. In doing this, we make several assumptions. For example, when filling in missing values for review rating, we assume that hosts with no indicated review rating would fall at least slightly below the average rating, because hosts with an average or above-average rating would most likely indicate that out of their best interest. Thus, we accounted for this skew by replacing the missing values with the mean value minus 5. Additionally, for listings which did not include a value for number of bathrooms, bedrooms, and beds, we also assumed that those missing values should be replaced with 0, 1, and 1, respectively.

```{r cleaning, message=FALSE}
#train
la$first_review <- as.Date(la$first_review, format = c("%Y-%m-%d"))
la$host_since <- as.Date(la$host_since, format = c("%Y-%m-%d"))
la$last_review <- as.Date(la$last_review, format = c("%Y-%m-%d"))
la$number_of_reviews <- as.numeric(la$number_of_reviews)
la$accommodates <- as.numeric(la$accommodates)

#dropping unnecessary levels nlevels() will return number of used levels
#train
la$neighbourhood <- droplevels(la$neighbourhood)
la$property_type <- droplevels(la$property_type)

#Changing response rate to integer by creating new column and deleting the old one
numextract <- function(string) { 
  str_extract(string, "\\-*\\d+\\.*\\d*")
}
la$response_rate <- as.integer(numextract(la$host_response_rate))
la <- select(la, -(host_response_rate))

#Removing bathroom NAs
la$bathrooms <- ifelse(is.na(la$bathrooms) == TRUE, 0, la$bathrooms)

#Removing review_scores_rating NAs
la$review_scores_rating <- ifelse(is.na(la$review_scores_rating) == TRUE, mean(la$review_scores_rating, na.rm = TRUE) - 5, la$review_scores_rating)

#Removing bedrooms 27 NAs (mean 1.335) set to 1 because NAs indicates low value
la$bedrooms <- ifelse(is.na(la$bedrooms) == TRUE, 1, la$bedrooms)

#Removing beds 42 NAs (mean 1.86) set to 1 because NAs indicates low value
la$beds <- ifelse(is.na(la$beds) == TRUE, 1, la$beds)

#Removing response rate NAs
la$response_rate <- ifelse(is.na(la$response_rate) == TRUE, mean(la$response_rate, na.rm = TRUE), la$response_rate)
```


###2.3 Manipulating and adding variables

We now begin adding or interpreting information that is somewhat hidden inside the dataset.

Using the information provided, we create new variables including price (nightly rate), days since last review (which was recorded on 10/02/2017), days since first review, days of host experience, median income by zipcode as an indicator high rents, and distances from popular tourist destinations in LA.

```{r manipulation train, message=FALSE}
#10/02/2017 was last recorded review
la$daysLastReview <- as.numeric(la$last_review[order(la$last_review, decreasing = TRUE)[1]] - la$last_review)
la$daysHost <- as.numeric(la$host_since[order(la$host_since, decreasing = TRUE)[1]] - la$host_since)
la$daysFirstReview <- as.numeric(la$first_review[order(la$first_review, decreasing = TRUE)[1]] - la$first_review)

#removing NAs
la$daysFirstReview <- ifelse(is.na(la$daysFirstReview) == TRUE, mean(la$daysFirstReview, na.rm = TRUE), la$daysFirstReview)
la$daysHost <- ifelse(is.na(la$daysHost) == TRUE, mean(la$daysHost, na.rm = TRUE), la$daysHost)
la$daysLastReview <- ifelse(is.na(la$daysLastReview) == TRUE, mean(la$daysLastReview, na.rm = TRUE), la$daysLastReview)
```

We also must now handle the information on amenities because the data was provided to us in the form of over 67 thousand extremely long factors. The variable entry for each observation is a complete list containing all described amenities. We better organized this data by separating the amenities and creating a dummy variable for the major, most frequent ones.

Based on the number of characters in the "description" variable, we also classify the length of the description into one of three classes: short, medium, or long.

```{r}
#seperating amenities
la$amenities <- gsub("\\{", "", la$amenities)
la$amenities <- gsub("\\}", "", la$amenities)
la$amenities <- gsub("\"", "", la$amenities)

#divides la$amenities into different data points
#str_split(la$amenities, ",")

#adding price column
la$price <- exp(la$log_price)

la$TV <- as.factor(ifelse(str_detect(la$amenities, "TV") == TRUE, 1, 0))
la$heating <- as.factor(ifelse( str_detect(la$amenities, "Heating")== TRUE, 1, 0))
la$WiFi <-as.factor(ifelse( str_detect(la$amenities, "Wireless Internet") == TRUE, 1, 0))
la$Famfriend <- as.factor(ifelse(str_detect(la$amenities, "Family/kid friendly") == TRUE, 1, 0))
la$AC <- as.factor(ifelse(str_detect(la$amenities, "Air conditioning") == TRUE, 1, 0))
la$pets <- as.factor(ifelse(str_detect(la$amenities, "Pets allowed") == TRUE, 1, 0))
la$smoking <- as.factor(ifelse(str_detect(la$amenities, "Smoking allowed") == TRUE, 1, 0))
la$bedroomLock <- as.factor(ifelse((str_detect(la$amenities, "Lock on bedroom door") | str_detect(la$amenities, "Smart lock")) == TRUE, 1, 0))
la$doorman <- as.factor(ifelse(str_detect(la$amenities, "Doorman") == TRUE, 1, 0))
la$hottub <- as.factor(ifelse(str_detect(la$amenities, "Hot tub") == TRUE, 1, 0))
la$hair <- as.factor(ifelse(str_detect(la$amenities, "Shampoo") | str_detect(la$amenities, "Hair dryer") == TRUE, 1, 0))

#classifying size of description and amenities
la$description <- as.character(la$description)
la$sizeDes <- ifelse(nchar(la$description) > 999, "long", ifelse(nchar(la$description) > 499, "medium", "short"))

#clustering cancellation policy
la$cancellation_policy <- ifelse(la$cancellation_policy == "super_strict_30", "strict", ifelse(la$cancellation_policy == "super_strict_60", "strict", ifelse(la$cancellation_policy == "strict", "strict", ifelse(la$cancellation_policy == "moderate", "moderate", ifelse(la$cancellation_policy == "flexible", "flexible", "NA")))))
la$cancellation_policy <- factor(la$cancellation_policy)

#clustering bed type
la$bed_type <- ifelse(la$bed_type == "Couch", "Couch_Futon", ifelse(la$bed_type == "Futon", "Couch_Futon", ifelse(la$bed_type == "Airbed", "Air_SofaBed", ifelse(la$bed_type == "Pull-out Sofa", "Air_SofaBed", ifelse(la$bed_type == "Real Bed", "Real Bed", "NA")))))
la$bed_type <- factor(la$bed_type)
```

``` {r}
neighbourhoodList <- tapply(la$log_price, INDEX = la$neighbourhood, FUN = median)
neighbourhoodList <- neighbourhoodList[order(neighbourhoodList)]
neighbourhoodList <- data.frame(neighbourhoodList)
neighbourhoodList$neighbourhood <- rownames(neighbourhoodList)
neighbourhoodList <- rename(neighbourhoodList, "medianPrice" = neighbourhoodList)
neighbourhoodList$medianPrice <- as.numeric(neighbourhoodList$medianPrice)

propertyList <- tapply(la$log_price, INDEX = la$property_type, FUN = median)
propertyList <- propertyList[order(propertyList)]
propertyList <- data.frame(propertyList)
propertyList$property_type <- rownames(propertyList)
propertyList <- rename(propertyList, "medianPrice" = propertyList)
propertyList$medianPrice <- as.numeric(propertyList$medianPrice)

la <- merge(la, neighbourhoodList, by.x = "neighbourhood", by.y = "neighbourhood")
la <- merge(la, income, by.x= "zipcode", by.y = "zipcode")

la$host_has_profile_pic <- ifelse(la$host_has_profile_pic == "", TRUE, ifelse(la$host_has_profile_pic == "t", TRUE, FALSE))
la$host_identity_verified <- ifelse(la$host_identity_verified == "", TRUE, ifelse(la$host_identity_verified == "t", TRUE, FALSE))
```

Next, we are going to add a few points of interest around LA to determine the effect of a properties distance from them in determining rental price. This could be also be interesting for people who want to acquire properties to rent them out.

```{r adding attractions, message=FALSE}
a0 <- c(-118.2437, 34.0522) # centre
a1 <- c(-118.329, 34.0928) # sunset blvd
a2 <- c(-118.491, 34.0195) # santa monica blvd
a3 <- c(-117.919, 33.8121) #disneyland
a4 <- c(-118.3514, 34.1362) #universal studios
a5 <- c(-118.4029, 34.0692) #rodeo drive

#Creating a distance variable in m
la$distA0 <- distHaversine(la[ , c("longitude", "latitude")], a0)
la$distA1 <- distHaversine(la[ , c("longitude", "latitude")], a1)
la$distA2 <- distHaversine(la[ , c("longitude", "latitude")], a2)
la$distA3 <- distHaversine(la[ , c("longitude", "latitude")], a3)
la$distA4 <- distHaversine(la[ , c("longitude", "latitude")], a4)
la$distA5 <- distHaversine(la[ , c("longitude", "latitude")], a5)
```

Lastly, we delete the unnecessary variables that do not provide any valuable, usable information (e.g. city), do not have any predictive power regarding price (e.g. thumbnail url), or have already been manipulated/dealt with for the purposes of our analysis (e.g. description).

```{r dropping columns, message = FALSE}
la$id <- NULL
la$amenities <- NULL
la$host_since <- NULL
la$last_review <- NULL
la$first_review <- NULL
la$description <- NULL
la$thumbnail_url <- NULL
la$city <- NULL
```

##3.0 Exploring and visualizing the data

Now that we have extracted, cleaned, and manipulated the data, we begin exploring the data in order to gain some general insights about the Airbnb market in Los Angeles.

```{r hist price, message = FALSE}
pPrice <- ggplot(data = la, aes(x = la$price))
pPrice + geom_histogram(fill= "brown2", color="brown1") + ggtitle("Distribution of Nightly Airbnb Prices in L.A.") + xlab("Nightly Rate ($)")
```

Noting the large number of outliers, we then exclude all prices greater than or equal to $300/night and again check the distribution of prices.

```{r}
#Creating subset of data with fewer price outliers
la1 <- la[la$price<300, ]

#Improving view of (core) price distribution
summary(la$price)
boxplot(la1$price, main="Boxplot of Nightly Airbnb Prices in L.A., Excluding Outliers", ylab="Nightly Rate ($)",
               frame.plot = FALSE,  # don't draw frame
               staplewex = 0,       # don't draw staples
               staplecol = "white", # fixes display issue
               boxwex = .75,        # narrow the boxes slighlty
               boxfill = "brown2",  # colour boxes
               whisklty = 1,        # dotted whiskers
               whiskcol = "brown2", # colour whiskers
               boxcol = "brown2",   # dim the box borders
               outcol = "brown2",   # dim the outliers
               outpch = 20,         # outliers as solid dots
               outcex = 0.5)
```

The above exploration of prices in la reveals that the middle 50% of Airbnbs in la are priced between 70-170 per night. Overall, the data is skewed to the left with 50% of the data being 100 or below in price while the mean price is higher, just over 155, due to the significant amount of highly expensive outliers. As shown in the boxplot, the cut-off for outlier classification appears to occur around $260/night. This tells property owners that prices higher than this are not going to be typical for the area.

```{r price count hist, message=FALSE}
pPrice <- ggplot(data = la, aes(x = la$log_price))
pPrice + geom_histogram(fill= "brown2", color="brown1")
```

The graph above shows the frequency of prices in Airbnb rentals. As we can see from this, prices appear to be approximately normally distributed and the majority of Airbnb rentals fall between a natural log price of 4 and 5. In making recommendations for Airbnb owners who are renting their homes/apartments, this information is useful in determining how they should price their property. We see that few fall above 6 on this graph and few falls below 4 which they can use because they know that above 6 is likely too pricey for people to want to rent and anything below 4 might mean they are not earning enough. 

Now that we have an overall view of the distribution of price, we more specifically explore the impact of certain other variables on price.

```{r}
#Viewing the most expensive neighborhoods
c <- tapply(la$price, la$neighbourhood, mean)
c <- sort(c, decreasing=TRUE)
barplot(c[1:5], main="Highest Mean Price by Neighborhood", xlab="Neighborhood", ylab="Mean Nightly Rate ($)", col = ("brown2"))
head(c)
```

We find that the neighborhoods that are generating the most average revenue per night are:

1. Wilmington ($1,300/night)
2. Bel Air/Beverly Crest ($528/night)
3. Malibu ($523/night)
4. Palos Verdes ($414/night)
5. Pacific Palisades ($386/night)
6. laurel Canyo ($382/night)

Therefore, owners of property in this area must know that they can charge more for their rental because customers are more willing to pay for it. We can conclude that these areas are in more demand and therefore cost more. So, it might be fruitful for more people to rent Airbnbs in this area if they would like to open more. 

The effect of number of bedrooms and bathrooms on price is explored below:

Generally speaking, more bedrooms for the same type of property generate a higher price. Same is true for an increasing number of bedrooms for the same number of beds. This happens, because the number of bedrooms is an indicator for how many people can stay. Obviously, larger apartments are rented out for a higher rate. But as the ratio of beds per bedroom decreases, the comfort increases. This means that people are going to be willing to pay more, because they would not have to share a room.

For renters, this means that they should aim to minimize this ration of beds per bedroom. For apartments that they already own, this could be achieved by dividing existing rooms into several rooms. When buying new apartments, renters should look to buy places that can be transformed in such a way or already have a structure of many small rooms.

```{r}
heatmapPropBed <- ggplot(data = la, aes(x= bedrooms, y= property_type))
heatmapPropBed + geom_tile(aes(fill= log_price), colour = "white")+ scale_fill_gradient(low = "white", high = "brown2") + xlab("Number of Bedrooms") + ylab("Property Type")
```
```{r}
heatmapBedsBed <- ggplot(data = la, aes(x= bedrooms, y= beds))
heatmapBedsBed + geom_tile(aes(fill= log_price), colour = "white")+ scale_fill_gradient(low = "white", high = "brown2") + xlab("Number of Bedrooms") + ylab("Number of Beds")
```

Next, the effect of room type on price is explored below:

```{r}
#Graphing a jitter plot, including all outliers
pricevroomtype <- ggplot(la, aes(x = room_type, y=price, color = room_type))
pricevroomtype + geom_jitter(alpha=0.25) + ggtitle("Nightly Price as a Function of Room Type") + xlab("Type of Room") + ylab("Nightly Rate ($)") + scale_color_manual(name = "Room Type", values = c("brown2", "turquoise4", "honeydew4"), labels = c("Entire Home/ Apartment", "Private Room", "Shared Room"))
```

As we would expect, these graphs shows that there is certainly a significant relationship between room type and price. Shared rooms are the cheapest with rates rarely exceeding 250/night. Entire homes/apartments are the most expensive, and they account for a substantial portion of the total number of price outliers (about $260 and higher). Additionally, we see the graph below in terms of the number of these types of rooms available:

```{r}
pRoomType <- ggplot(la, aes(x = room_type, fill = room_type))
pRoomType + geom_bar() + scale_fill_manual(name = "Room Type", values = c("brown2", "turquoise4", "honeydew4"), labels = c("Entire Home/ Apartment", "Private Room", "Shared Room"))
```

Above, we have a graph detailing the number of Airbnb rental properties in LA that are an entire home/apartment, ones that are a private room, and ones that are shared rooms. From a property owner's point of view, this information is important to know because it shows what types of properties are available to customers throughout the region. We see that the majority of properties are entire homes/apartments and there are also a good number of private rooms available. This could be indicative of the customer type in LA because since there are more private spaces, we can assume that shared rooms are not as sought after in the area. Therefore, this tells Airbnb owners that shared spaces are not as competitive in the LA market and that in order to succeed, they most likely will need to rent out entire homes/apartments or at least private rooms. 

```{r reviews number, message = FALSE}
pNumberReviews <- ggplot(data = la[la$number_of_reviews < 200, ], aes(x = number_of_reviews))
pNumberReviews + geom_histogram(fill= "brown2", color="brown2")

#pNumberReviews <- ggplot(data = la[la$number_of_reviews < 200, ], aes(x = log_price, y = number_of_reviews, color = daysLastReview))
#pNumberReviews + geom_point(size = 1, alpha = 1) + scale_color_gradient(low = "white", high = "brown2")
```

The above graph shows the distribution of the number of reviews given to rental properties in Los Angeles. Through this graph, we see that most properties receive a small amount of reviews. This information can be used by owners of Airbnb property in a couple different ways. One, it tells them that a lot of other properties do not have a large amount of reviews. Second, depending on whether or not reviews are influential to a tenant decision to book the property, that can shape whether or not they seek out people to review their property. If reviews do turn out to be influential, it is important for property owners to use this to evaluate how they stand compared to other properties and potentially increase reviews. If reviews are not significant, then Airbnb owners can ignore this factor and focus on different aspects of their rental properties to improve in order to increase bookings. 


```{r}
boxplot(price ~ sizeDes, data=la1, main="Price Distribution as a Function of Description Length", xlab="Length of Description", ylab="Nightly Rate ($)",
               frame.plot = FALSE,  # don't draw frame
               staplewex = 0,       # don't draw staples
               staplecol = "white", # fixes display issue
               boxwex = .75,        # narrow the boxes slighlty
               boxfill = "brown2",  # colour boxes
               whisklty = 1,        # dotted whiskers
               whiskcol = "brown2", # colour whiskers
               boxcol = "brown2",   # dim the box borders
               outcol = "brown2",   # dim the outliers
               outpch = 20,         # outliers as solid dots
               outcex = 0.5)

#pricevsizeDes <- ggplot(la, aes(x = sizeDes, y=price, colour = sizeDes))
#pricevsizeDes + geom_jitter(alpha=0.25) + ggtitle("Nightly Price as a Function of Description Length") + xlab("Length of Description") + ylab("Nightly Rate ($)")
```

We find that the length of the listing's description has very little to no impact on the listing's price. Interestingly, compared to short and long descriptions, descriptions of medium length appear to have relatively fewer outliers at the upper end of price; overall, however, the distribution appears the same. Therefore, people listing their properties need not be concerned with how long their description is. 

The graph below is used to cluster property types by their median price level. It shows boxplots for each property type. The vertical lines indicate the chosen groups of clustering. The clustering is necessary to not fully loose the information about the property type while reducing its complexity so that the models below can work with it. The graph also indicates that property types are a significant value driver, because the boxplots all lay in short intervals of the price range. If they were all spread out over the whole range of price this would mean that we could exclude this variable from further analysis.

```{r graph price neighbourhoods and property}
Neighbourhood <- ggplot(data = la, aes(x=log_price, y = reorder(neighbourhood, log_price, median)))
Neighbourhood + geom_boxplot(color = "brown2") + ylab("Neighbourhood")

property <- ggplot(data = la, aes( x = log_price, y = reorder(property_type, log_price, mean) ) )
property + geom_boxplot(color = "brown2") + geom_vline(xintercept= c(4.25, 4.75, 5.25, 5.75), colour = "grey" , linetype = 2) + ylab("Property Type")
```

```{r propertyClus, message = FALSE}
la$propertyCluster <- ifelse( (la$property_type == "Lighthouse")  |  (la$property_type == "Castle") |
                              (la$property_type == "Vacation home")  |  (la$property_type == "Train") |
                              (la$property_type == "Earth House")  |  (la$property_type == "Treehouse"), 5,
                            
                      ifelse( (la$property_type == "Tipi")  |  (la$property_type == "Villa") |
                              (la$property_type == "Loft")  |  (la$property_type == "Yurt") |
                              (la$property_type == "Other")  |  (la$property_type == "Guesthouse"), 4,
                              
                      ifelse( (la$property_type == "Boat")  |  (la$property_type == "Serviced apartment") |
                              (la$property_type == "Bungalow")  |  (la$property_type == "Condominium") |
                              (la$property_type == "Townhouse")  |  (la$property_type == "Guesthouse") |
                              (la$property_type == "Island"), 3,
                              
                      ifelse( (la$property_type == "House")  |  (la$property_type == "Apartment") |
                              (la$property_type == "Chalet")  |  (la$property_type == "Boutique hotel") |
                              (la$property_type == "Cabin")  |  (la$property_type == "Guest suite") |
                              (la$property_type == "Bed & Breakfast") | (la$property_type == "Cave"), 2, 1
                                
                              ) ) ) )
la$propertyCluster <- as.factor(la$propertyCluster)
```

##4.0 Building price models

###4.1 Price Prediction with Linear Regression

With our linear regression model, we hope to find more value drivers and validate the recommendations that we found above. But first, let's look at the distances to touristic hotspots that we introduced earlier. For each hotspot, the graphs below show if there is a correlation between distance and price. For Sunset Blvd, Santa Monica Blvd, Universal Studios and Rodeo Drive, the Pearson Correlation suggests that there is a decrease of nightly rate for increasing distance. Only the city center and Disneyland don't seem to be relevant to a valuable location. Note however, that these graphs look at the individual relationship between price and distance and don't take into account other factors. For that matter, they only indicate if these locations should be included in the linear model.

```{r}
grid.arrange(
  ggscatter(la, x = "distA0", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to City Center", ylab = "log Price", size = 0.3, alpha = 0.2 ),
  ggscatter(la, x = "distA1", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to Sunset Blvd.", ylab = "log Price", size = 0.3, alpha =0.2 ),
  ggscatter(la, x = "distA2", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to Santa Monic Blvd.", ylab = "log Price", size = 0.3, alpha = 0.2 ),
  ggscatter(la, x = "distA3", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to Disneyland", ylab = "log Price", size = 0.3, alpha = 0.2 ),
  ncol = 2
)

grid.arrange(
  ggscatter(la, x = "distA4", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to Universal Studios", ylab = "log Price", size = 0.3, alpha = 0.2 ),
  ggscatter(la, x = "distA5", y = "log_price", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Distance to Rodeo Drive", ylab = "log Price", size = 0.3, alpha =0.2 ),
  ncol = 2
)
```

For our model, we started by including all variables that were found to be significant in the analysis above, excluding variables like neighborhood or zip (too many levels, using median Price and income instead), description or response rate (insignificant).

```{r}
testModel <- lm(log_price ~ room_type + propertyCluster + accommodates + bathrooms + number_of_reviews + review_scores_rating + bedrooms + beds + response_rate + daysFirstReview + daysHost + daysLastReview + distA0 + distA1 + distA2 + distA3 + distA4 + distA5 + medianPrice + income + cleaning_fee + cancellation_policy + TV + heating + WiFi + Famfriend + AC + pets + smoking + bedroomLock + doorman + hottub + hair + instant_bookable , data = la)

summary(testModel)
```

```{r, echo=FALSE }
testStep <- step(testModel)
```

```{r}
secondModel <- lm(log_price ~ room_type + propertyCluster + accommodates + bathrooms + 
    number_of_reviews + review_scores_rating + bedrooms + beds + 
    response_rate + daysFirstReview + daysLastReview + distA0 + 
    distA1 + distA2 + distA3 + distA4 + distA5 + medianPrice + 
    income + cleaning_fee + cancellation_policy + TV + WiFi + 
    Famfriend + AC + pets + bedroomLock + doorman + hottub + 
    instant_bookable , data = la)

summary(secondModel)
```

```{r}
attraction <- c("City Center", "Sunset Boulevard", "Santa Monica Boulevard", "Disneyland", "Universal Studios", "Rodeo Drive")

recommendation <- c("Closeness is not essential. You should rather focus on the other attractions.", "Closeness is a  pretty essential factor. You can charge more if your apartment is close.", "Closeness is a very essential factor. You can charge more if your apartment is close.", "Closeness is not essential. You should rather focus on the other attractions.", "Closeness is not essential. You should rather focus on the other attractions.", "Closeness is not essential. You should rather focus on the other attractions.")

significance <- c(0, 1, 1, 0, 0, 0)

map <- data.frame(a0, a1, a2, a3, a4, a5)
map <- t(map)
map <- as.data.frame(map)

map <- data.frame(map, attraction, significance, recommendation)

map <- rename(map, "longitude" = V1, "latitude" = V2)

leaflet(data = map) %>% addTiles() %>% addCircleMarkers (radius = 10, color = ~ ifelse(significance == 0, "red", "green"), stroke = FALSE, fillOpacity = 0.75, ~ longitude, ~ latitude, label = ~ paste(attraction, ": " , recommendation))
```

(The map is interactive. Hover over the market locations with the cursor to reveal the name of the attraction and recommendation regarding the closeness to the attraction.)

Our analysis revealed that closeness to the *Santa Monica Boulevard* and *Sunset Boulevard* is a statistically significant factor regarding the price. In other words, you can charge more if you are closer to these locations.

For the other locations * Rodeo Drive*, *Universal Studios, **City Center* and * Disneyland* the linear regression technically suggested that being further away allows the Airbnb owner to charge more. However, one should keep in mind that this can also result from different locations nearby. Therefore, we limit our recommendation by saying that being close to these locations is not a factor you should include when pricing your apartment.

###4.2 Price Prediction with Neural Network

For everyone who starts renting out Airbnb apartments we build a combined machine learning solution which predicts the price of your apartment. The predicted price functions as a good reference point when pricing your apartment.  

```{r setup ann, message = FALSE}
library(caret)

set.seed(1)
in.train <- createDataPartition(la$log_price, p = 0.90, list = FALSE)
la.train <- la[in.train, ]
la.test.n <- la[-in.train, ]

#la$host_has_profile_pic <- ifelse(la$host_has_profile_pic == "", TRUE, ifelse(la$host_has_profile_pic == "t", TRUE, FALSE))
#la$host_identity_verified <- ifelse(la$host_identity_verified == "", TRUE, ifelse(la$host_identity_verified == "t", TRUE, FALSE))

#normailize function
normalize <- function(x) { 
  return((x - min(x)) / (max(x) - min(x)))
}

#converting the property Cluster to a numeric value conserving the ordinal information regarding the median income
propertyCluster.num <- as.character(la.train$propertyCluster)
propertyCluster.num <- as.numeric(propertyCluster.num)

#isolating the numeric variables 
la_ann_num <- data.frame(la.train$log_price, propertyCluster.num, la.train$accommodates, la.train$bathrooms , la.train$number_of_reviews, la.train$review_scores_rating, la.train$bedrooms, la.train$beds, la.train$daysLastReview, la.train$daysHost, la.train$daysFirstReview, la.train$medianPrice, la.train$income, la.train$distA0, la.train$distA1, la.train$distA2, la.train$distA3, la.train$distA4, la.train$distA5)

#normailizing the numeric values using the min-max normailization
la_ann_num <- as.data.frame(lapply(la_ann_num, normalize))

#isolating the factors
la_ann_fac <- data.frame(la.train$room_type, la.train$cleaning_fee, la.train$TV, la.train$heating, la.train$WiFi, la.train$Famfriend, la.train$AC, la.train$pets, la.train$smoking, la.train$bedroomLock, la.train$doorman, la.train$hottub, la.train$hair)

#converting the factors to 0s and 1s 
la_ann_fac <- as.data.frame(model.matrix(~.-1, data = la_ann_fac))

#combing the numeric values with the converted factors 
la.train <- data.frame(la_ann_num, la_ann_fac)

la.train <- rename(la.train, "log_price" = la.train.log_price)

a <- as.formula(paste('log_price ~',paste(colnames(la.train[2:ncol(la.train)]),collapse = '+')))

la_model <- neuralnet(formula = a, data = la.train)
```

```{r test ann, message = FALSE}
la.test <- la.test.n

#converting the property Cluster to a numeric value conserving the ordinal information regarding the median income
propertyCluster.num <- as.character(la.test$propertyCluster)
propertyCluster.num <- as.numeric(propertyCluster.num)

#isolating the numeric variables 
la_ann_num <- data.frame(la.test$log_price, propertyCluster.num, la.test$accommodates, la.test$bathrooms , la.test$number_of_reviews, la.test$review_scores_rating, la.test$bedrooms, la.test$beds, la.test$daysLastReview, la.test$daysHost, la.test$daysFirstReview, la.test$medianPrice, la.test$income, la.test$distA0, la.test$distA1, la.test$distA2, la.test$distA3, la.test$distA4, la.test$distA5)

#normailizing the numeric values using the min-max normailization
la_ann_num <- as.data.frame(lapply(la_ann_num, normalize))

#isolating the factors
la_ann_fac <- data.frame(la.test$room_type, la.test$cleaning_fee, la.test$TV, la.test$heating, la.test$WiFi, la.test$Famfriend, la.test$AC, la.test$pets, la.test$smoking, la.test$bedroomLock, la.test$doorman, la.test$hottub, la.test$hair)

#converting the factors to 0s and 1s 
la_ann_fac <- as.data.frame(model.matrix(~.-1, data = la_ann_fac))


#combing the numeric values with the converted factors 
la.test <- data.frame(la_ann_num, la_ann_fac)

la.test <- rename(la.test, "log_price" = la.test.log_price)


model_results <- compute(la_model, la.test[-4])

ann_results <- as.data.frame(model_results$net.result)

set.seed(1)
in.train <- createDataPartition(la$log_price, p = 0.90, list = FALSE)
la.train <- la[in.train, ]
la.test.n <- la[-in.train, ]

#"denormalizing the predicted results"
denormalize <- function(y) { 
  return (y*((max(la.train$log_price) - min(la.train$log_price)) + min(la.train$log_price)))
}

ann_results <- as.data.frame(lapply(ann_results, denormalize))

comparison <- data.frame(la.test.n$log_price, ann_results)

comparison$intervallow <- comparison$la.test.n.log_price*0.7
comparison$intervalup <- comparison$la.test.n.log_price*1.3
comparison$interval <- ifelse(comparison$V1 < comparison$intervalup & comparison$V1 > comparison$intervallow, 1, 0) 

comparison$interval <- ifelse(comparison$interval == 1, "Yes", "No")

value <- transform(as.data.frame(table(comparison$interval)),percentage=Freq/nrow(la.test)*100)

Createplot <- function (x, title){
x <- table(x)
x <- as.data.frame(x)
names(x) <- c("Legend", "Freq")
x$Var1 <- NULL
library(scales)
x <- ggplot(x, aes(x="", y=Freq, fill=Legend))+ geom_bar(width=1, stat="identity")+ coord_polar("y", start=0) + ylab(NULL) + xlab(NULL)+ scale_fill_brewer(palette="Blues")+ theme_minimal()+ theme(panel.border=element_blank(), panel.grid=element_blank(), axis.ticks=element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(), axis.text.x=element_blank()) 
return(x)
}
Createplot(comparison$interval, "Prediction within Range?") + scale_fill_manual(values=c("Brown2", "Turquoise4")) + ggtitle("Prediction within Range?", subtitle ="[+/- 30%]") + theme(plot.title = element_text(hjust=0.5, size = 16)) + geom_text(label = round(value$percentage[1], digit = 2), y = -130) + theme(plot.subtitle=element_text(size=14, hjust=0.5, color="black")) + geom_text(label = round(value$percentage[2], digit = 2), y = 450) + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 10))
```

As of now, our algorithm can predict the price within a range of +-30% of the actual price for `r round(value$percentage[2])`% of the apartments. We would recommend to increase the accuracy of this algorithm furthermore by adding more relevant variables to the dataset: a walkability score that measures how well the neighborhood is connected via public transport or a measurement for how positive the description and name are written (R provides a "sentimentAnalysis" function to measure this). We did not include these variables for now because of time constraints.

We would highly recommend to improve this algorithm to a point where it can suggest a nightly rate for renters. They can then use this algorithm to enter the data of a potential apartment they would want to buy and instantly get a result for how much the nightly rate would be. Additionally, they could check if their current nightly rate is as high as it can be or maybe too high. This should ultimately maximize the demand for their apartments and therefore maximize their profits.

##5.0 Concluding recommendations for Airbnb hosts

Based upon the analysis we have done throughout this project, there are a few recommendations we would give to property owners who rent out their spaces through Airbnb: 

*1. Pricing*: AirBnB properties are typically rented for about 70-170 dollars per night in and around LA. Outliers tend to be greater than 260 dollars, but there are a few neighborhoods which can consistently charge more. In which specific neighborhoods property owners can charge more just because of the neighborhood they are in can be found in our analysis in Section 3.0.  

*2. Bedrooms/Private Space*: Generally, as the number of bedrooms in a property increases, the more the owner is able to charge for that property. Further, more private spaces are more prominent leading us to believe they are more popular amongst customers. So, we recommend that owners charge more for listings with multiple bedrooms and also for listings that do not have shared rooms or are an entire home or apartment. 

*3. Location*: Airbnb property owners should take into consideration the location of their rental listing. For instance, there are some neighborhoods and attractions that one can raise the price near and some that will have no or negative impact on the price. Santa Monica Boulevard and Sunset Boulevard are two attractions in LA that warrant a higher price to customers. None of the other locations we tested had the same results. Therefore, those should not be taken into consideration of price, but the two positive attractions should. 

*4. Cancellation Policy*: An interesting find in our regression is the impact of cancellation policy on the price charged. Properties with strict or moderate strict cancellation policies was more correlated with a reduction in the price of the property than ones with relaxed or moderate cancellation policies. Therefore, we would recommend that a property owner could raise their price while being more lenient on their cancellation policy in order to charge more per night. 

*5. Apartment Description*: In our analysis we found out that there is no need for long descriptions. The length of the description does not seem to play an important role for the users as it does not correlate with price/willingness to pay. 

*6. Amenities*: The linear regression model showed that certain amenities have a bigger impact on the price than others. Whether an apartment has a doorman, pets, AC and TV correlate generally with higher rates. However, one should keep in mind that users are not likely to pay more for an Airbnb apartment just because it has a doorman but apartments with a doorman tend to be more expensive. Therefore, we advise users to only think about hiring a doorman if the apartment in general is luxurious and more expensive. Nevertheless, AC, TV, and allowing pets are definitely things middleclass apartment owners should consider installing in the apartment, if they're not already. In addition, our analysis revealed that allowing users to smoke inside the apartments has a negative influence on the price. Therefore, hosts should generally not allow smoking inside and advise users to smoke outside. Finally, hair-care products (hairdryer and shampoo) did not have a big impact on the price of an apartment. We advise hosts to not increase the price of their apartment just because they offer these things, which makes intuitive sense, because these factors are now seen as minimal hygiene requirements more than they are seen as "bonuses" or notable, value-driving amenities. 

##6.0 Concluding recommendations for Airbnb management

Operating under the assumption that Airbnb makes a significant portion of its revenue through fees based on a percentage of each transaction amount (an assumption which we partially checked/validated), it's in Airbnb's best interest to market to property owners to recruit more homes and consumers on the upper end of the price range. We recommend that Airbnb targets their marketing efforts geographically and, if possible, towards consumers with a whole apartment, or at least a private room, to rent out. Specifically, rather than targeting at the city level, the geographic targeting should be further broken down to the sub-city (neighborhood) level. Recruiting more hosts/# of overall transactions in higher priced neighborhoods could help drive future revenue.

Airbnb could further enhance both its revenue and its services to its hosts by offering the insights contained in Section 5.0 and other advice/price optimizing information such that it's readily accessible and understandable/usable by the hosts. It can improve its services by, for example, launching an interactive platform which can inform hosts if they are underpricing/undervaluing their home and can recommend an updated price to more accurately reflect the market's equilibrium price for that home. Similarly, they could also inform hosts if they are overpricing/overvaluing their home. Despite the price reduction, suggesting a more competitive price could help increase # of transactions enough to actually increase revenue both for hosts and for Airbnb as a whole, depending on several factors (time, location, elasticity of demand, etc.).

Additionally, we recommend the platform/service should also suggest changes to optimize their hosts' listings. For example, Airbnb could suggest features/amenities to offer at hosts' homes in order to boost their value to consumers. Specifically, from Section 5.0, such recommendations could include making a TV available, marketing the host's (close) proximity to Santa Monica or Sunset Boulevards, or prohibiting smoking. In addition to benefiting Airbnb's and the hosts' top lines, this would improve the market's offering for consumers of Airbnb as well, because the market would better change to meet their demands. As a result, consumers' overall average willingness to pay would increase.

We'd also recommend that Airbnb changes its settings such that data entries by hosts into the listing are "forced entry." Because we had so many NAs in our data, we had to add some extent of inaccuracy into the data in order to use it. Forcing responses to listing features such as number of bed/bathrooms will facilitate more accurate data collection and analysis in the future.

Finally, we recommend the following next steps to improve our predictive modeling. Due to time constraints, our team was unable to examine interaction between variables, but looking at variable interactions will likely make our model(s) more accurate and robust. As previously mentioned, we also recommend proceeding with sentiment analysis, because our analysis of the description (only focusing on its length) was a very limited, narrow focus which did not take the content of the description into account.